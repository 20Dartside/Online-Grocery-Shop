<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Cart ‚Äî SnackShop</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
  <!-- Top Bar -->
  <div class="top-bar">Just Dropped: Fresh & Spice Namkeen üéÉ</div>

  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">Namkeen <span>Snacks</span></div>
    <nav>
      <ul>
        <li><a href="{{ url_for('index') }}">HOME</a></li>
        <li><a href="{{ url_for('order') }}">ORDER <span class="new">NEW</span></a></li>
        <li><a href="{{ url_for('products') }}">PRODUCTS <span class="tag">BESTPRODUCT</span></a></li>
        <li><a href="{{ url_for('cart') }}">CART</a></li>
        <li><a href="{{ url_for('about') }}">ABOUT US</a></li>
      </ul>
    </nav>

    <!-- Profile Sidebar -->
    <div id="profileSidebar" class="profile-sidebar">
      <span class="close-profile" onclick="toggleProfile()">‚úñ</span>
      <div class="profile-header" id="profileName">üë§ Guest</div>

      <div class="profile-menu">
        <button onclick="toggleSection('ordersSection')">üì¶ Your Orders</button>
        <button onclick="toggleSection('listSection')">üìù Your List (Cart)</button>
        <button onclick="toggleSection('buyagainSection')">üîÑ Buy Again</button>
      </div>

      <div class="profile-section" id="ordersSection" style="display:none;">
        <h3>Your Orders</h3>
        <div id="ordersList"></div>
      </div>

      <div class="profile-section" id="listSection" style="display:none;">
        <h3>Your Cart</h3>
        <div id="listItems"></div>
      </div>

      <div class="profile-section" id="buyagainSection" style="display:none;">
        <h3>Buy Again</h3>
        <div id="buyAgainItems"></div>
      </div>
    </div>

    <div class="icons"><a href="javascript:void(0)" onclick="toggleProfile()">üë§</a></div>
    <div class="logout-section"><button class="logout-btn" onclick="logoutUser()">üö™ Logout</button></div>
  </header>

  <!-- Main Cart Section -->
  <main class="container">
    <h1>Your Cart</h1>

    <table class="cart-table">
      <thead>
        <tr><th>Product</th><th>Price</th><th>Qty</th><th>Subtotal</th><th>Action</th></tr>
      </thead>
      <tbody id="cartBody"></tbody>
    </table>

    <div style="margin-top:18px;display:flex;justify-content:flex-end;gap:12px;align-items:center">
      <div style="text-align:right">
        <div style="font-size:16px;font-weight:700" id="totalPrice">Total: ‚Çπ0</div>
        <div style="color:var(--muted);font-size:14px">Shipping calculated at checkout</div>
      </div>
      <a class="btn" href="{{ url_for('checkout') }}">Proceed to Checkout</a>
    </div>
  </main>

  <footer class="site-footer"><div class="container">¬© SnackShop</div></footer>

  <script>
    // --------------------- CART ACTIONS ---------------------
    function renderCart() {
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const cartBody = document.getElementById("cartBody");
      let total = 0;
      cartBody.innerHTML = "";

      if (!cart.length) {
        cartBody.innerHTML = "<tr><td colspan='5' style='text-align:center'>üõí Your cart is empty</td></tr>";
        document.getElementById("totalPrice").innerText = "Total: ‚Çπ0";
        return;
      }

      cart.forEach((item, idx) => {
        const subtotal = item.price * item.qty;
        total += subtotal;
        cartBody.innerHTML += `<tr>
          <td>${item.name}</td>
          <td>‚Çπ${item.price}</td>
          <td>
            <button onclick="updateQty(${idx}, -1)">-</button>
            ${item.qty}
            <button onclick="updateQty(${idx}, 1)">+</button>
          </td>
          <td>‚Çπ${subtotal}</td>
          <td><button onclick="removeItem(${idx})">Remove</button></td>
        </tr>`;
      });

      document.getElementById("totalPrice").innerText = "Total: ‚Çπ" + total;
      renderProfileData();
    }

    function addToCart(product) {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      const existing = cart.find(p => p.id === product.id);
      if (existing) existing.qty += 1;
      else { product.qty = 1; cart.push(product); }
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
      alert(`${product.name} added to cart! üõí`);
    }

    function updateQty(idx, change) {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      cart[idx].qty += change;
      if (cart[idx].qty <= 0) cart.splice(idx, 1);
      localStorage.setItem("cart", JSON.stringify(cart));
      renderCart();
    }

    function removeItem(idx) {
      let cart = JSON.parse(localStorage.getItem("cart")) || [];
      if (confirm("Are you sure you want to remove this item?")) {
        cart.splice(idx, 1);
        localStorage.setItem("cart", JSON.stringify(cart));
        renderCart();
      }
    }

    // --------------------- PROFILE SIDEBAR ---------------------
    function renderProfileData() {
      const username = localStorage.getItem("username") || "Guest User";
      document.getElementById("profileName").innerText = "üë§ " + username;

      const orders = JSON.parse(localStorage.getItem("orders")) || {};
      const cart = JSON.parse(localStorage.getItem("cart")) || [];
      const buyAgain = JSON.parse(localStorage.getItem("buyAgain")) || {};

      const currentUser = username;
      renderOrders(orders[currentUser] || []);
      renderList(cart);
      renderBuyAgain(buyAgain[currentUser] || []);
    }

    function renderOrders(orders) {
      const container = document.getElementById("ordersList");
      container.innerHTML = orders.length ? orders.map(o => `<div class="order-card"><span>${o.name} - ‚Çπ${o.price} x ${o.qty}</span></div>`).join("") : "<p>No orders found.</p>";
    }

    function renderList(cart) {
      const container = document.getElementById("listItems");
      container.innerHTML = cart.length ? cart.map(c => `<div class="order-card"><span>${c.name} - ‚Çπ${c.price} x ${c.qty}</span></div>`).join("") : "<p>Your cart is empty.</p>";
    }

    function renderBuyAgain(items) {
      const container = document.getElementById("buyAgainItems");
      container.innerHTML = items.length ? items.map(b => `<div class="order-card"><span>${b.name} - ‚Çπ${b.price} x ${b.qty}</span></div>`).join("") : "<p>No previous products.</p>";
    }

    function toggleProfile() {
      document.getElementById("profileSidebar").classList.toggle("active");
      renderProfileData();
    }

    function toggleSection(id) {
      document.querySelectorAll(".profile-section").forEach(sec => {
        sec.style.display = sec.id === id ? "block" : "none";
      });
    }

    // --------------------- LOGOUT ---------------------
    function logoutUser() {
      localStorage.removeItem("isLoggedIn");
      localStorage.removeItem("username");
      localStorage.removeItem("cart");
      localStorage.removeItem("orders");
      alert("You have been logged out!");
      window.location.href = "{{ url_for('logout') }}";
    }

    // --------------------- INITIAL LOAD ---------------------
    window.onload = function() {
      renderCart();
      renderProfileData();
    };
  </script>
</body>
</html>
