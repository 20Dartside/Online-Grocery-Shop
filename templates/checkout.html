<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Checkout ‚Äî SnackShop</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    /* Optional: inline error style */
    input:invalid, textarea:invalid, select:invalid {
      border: 1px solid red;
    }
  </style>
</head>
<body>
  <!-- Top Notification Bar -->
  <div class="top-bar">
    Just Dropped: Fresh & Spice Namkeen üéÉ
  </div>

  <!-- Navbar -->
  <header class="navbar">
    <div class="logo">Namkeen <span>Snacks</span></div>
    <nav>
      <ul>
        <li><a href="{{ url_for('index') }}">HOME</a></li>
        <li><a href="{{ url_for('order') }}">ORDER <span class="new">NEW</span></a></li>
        <li><a href="{{ url_for('products') }}">PRODUCTS <span class="tag">BESTPRODUCT</span></a></li>
        <li><a href="{{ url_for('cart') }}">CART</a></li>
        <li><a href="{{ url_for('about') }}">ABOUT US</a></li>
        <li>
          <a href="{{ url_for('shopall') }}">SHOP ALL ‚ñº</a>
          <ul>
            <li><a href="{{ url_for('snacks') }}">Snacks</a></li>
            <li><a href="{{ url_for('chuda') }}">Chuda</a></li>
            <li><a href="{{ url_for('poha') }}">Poha</a></li>
            <li><a href="{{ url_for('namkeen') }}">Namkeen</a></li>
          </ul>
        </li>
        <li>
          <a href="{{ url_for('cart') }}">CART ‚ñº</a>
          <ul>
            <li><a href="{{ url_for('checkout') }}">Checkout</a></li>
            <li><a href="{{ url_for('wishlist') }}">Wishlist</a></li>
          </ul>
        </li>
      </ul>
    </nav>

     <!-- Sidebar Profile -->
<div id="profileSidebar" class="profile-sidebar">
  <span class="close-profile" onclick="toggleProfile()">‚úñ</span>
  <div class="profile-header" id="profileName">
  üë§ {{ user.profile.name if user and user.profile else 'Guest' }}
</div>
<div class="profile-section">



</div>


  <!-- Menu Buttons -->
  <div class="profile-menu">
    <button onclick="toggleSection('ordersSection')">üì¶ Your Orders</button>
    <button onclick="toggleSection('listSection')">üìù Your List (Cart)</button>
    <button onclick="toggleSection('buyagainSection')">üîÑ Buy Again</button>
  </div>

  <!-- Orders -->
  <div class="profile-section" id="ordersSection" style="display:none;">
    <h3>Your Orders</h3>
    <div id="ordersList"></div>
  </div>

  <!-- Cart -->
  <div class="profile-section" id="listSection" style="display:none;">
    <h3>Your Cart</h3>
    <div id="listItems"></div>
  </div>

  <!-- Buy Again -->
  <div class="profile-section" id="buyagainSection" style="display:none;">
    <h3>Buy Again</h3>
    <div id="buyAgainItems"></div>
  </div>
</div>

</div>

   <div class="icons">
  <a href="javascript:void(0)" onclick="toggleProfile()">üë§</a>
</div>
<!-- Logout Button -->
<div class="logout-section">
  <button class="logout-btn" onclick="logoutUser()">üö™ Logout</button>
</div>

  </header>

  <main class="container">
    <h1>Checkout</h1>

    <form id="checkoutForm">
      <div class="form-row">
        <div class="field">
          <label>Full Name</label>
          <input type="text" placeholder="Enter your name" required />
        </div>
        <div class="field">
          <label>Phone</label>
          <input type="tel" placeholder="10-digit mobile number" pattern="[0-9]{10}" required />
        </div>
      </div>

      <div class="field">
        <label>Email</label>
        <input type="email" placeholder="example@email.com" required />
      </div>

      <div class="field">
        <label>Address</label>
        <textarea placeholder="Street, area, landmark..." minlength="10" required></textarea>
      </div>

      <div class="form-row">
        <div class="field">
          <label>City</label>
          <input type="text" placeholder="City" required />
        </div>
        <div class="field">
          <label>PIN / ZIP</label>
          <input type="text" placeholder="6-digit PIN" pattern="[0-9]{6}" required />
        </div>
      </div>

      <!-- Payment Dropdown -->
      <h3>Payment Type</h3>
      <div class="field">
        <label>Select Payment Method</label>
        <select required>
          <option value="">-- Select Payment --</option>
          <option value="cod">Cash on Delivery</option>
          <option value="upi">UPI</option>
          <option value="card">Debit / Credit Card</option>
          <option value="netbanking">Net Banking</option>
        </select>
      </div>

      <div style="margin-top:12px">
        <button class="btn" type="submit">Place Order</button>
      </div>
    </form>
  </main>

  <footer class="site-footer"><div class="container">¬© SnackShop</div></footer>

<script>
// ---------------------- CHECKOUT FORM SUBMIT ----------------------
document.getElementById("checkoutForm").addEventListener("submit", function(e) {
  e.preventDefault(); // prevent default submission

  const form = e.target;

  // ‚úÖ Use Flask session username instead of localStorage
  const currentUser = "{{ session.get('username', '') }}";

  // 1Ô∏è‚É£ Login check
  if (!currentUser) {
    alert("‚ö† Please login before placing an order.");
    window.location.href = "{{ url_for('login') }}";
    return;
  }

  // 2Ô∏è‚É£ Form validation
  if (!form.checkValidity()) {
    alert("‚ö† Please fill all required fields correctly!");
    return;
  }

  // 3Ô∏è‚É£ Cart check
  let cart = JSON.parse(localStorage.getItem("cart")) || [];
  if (cart.length === 0) {
    alert("‚ö† Your cart is empty!");
    return;
  }

  // 4Ô∏è‚É£ Collect form + cart + username
  const checkoutData = {
    full_name: form.querySelector('input[placeholder="Enter your name"]').value,
    phone: form.querySelector('input[pattern="[0-9]{10}"]').value,
    email: form.querySelector('input[type="email"]').value,
    address: form.querySelector('textarea').value,
    city: form.querySelector('input[placeholder="City"]').value,
    pin: form.querySelector('input[placeholder="6-digit PIN"]').value,
    payment: form.querySelector('select').value,
    username: currentUser,
    cart: cart
  };

  // 5Ô∏è‚É£ Send to Flask backend
  fetch("/save_checkout", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(checkoutData)
  })
  .then(res => res.json())
  .then(data => {
    if (data.status === "success") {
      alert("üéâ Order placed successfully & saved to database!");
      localStorage.setItem("cart", JSON.stringify([])); // clear cart
      renderProfileData(); // refresh sidebar
    } else {
      alert("‚ö† Error saving order: " + data.msg);
    }
  })
  .catch(err => {
    console.error(err);
    alert("‚ö† Something went wrong while placing the order.");
  });
});

// ---------------------- SIDEBAR FUNCTIONS ----------------------
function toggleProfile() {
  document.getElementById("profileSidebar").classList.toggle("active");
  renderProfileData();
}

function toggleSection(id) {
  document.querySelectorAll(".profile-section").forEach(sec => {
    sec.style.display = (sec.id === id) ? "block" : "none";
  });
}

// ---------------------- RENDER PROFILE, ORDERS, CART, BUY AGAIN ----------------------
function renderProfileData() {
  const currentUser = "{{ session.get('username', '') }}";

  document.getElementById("profileName").innerText = currentUser
    ? "üë§ " + currentUser
    : "üë§ Guest User";

  const allOrders = JSON.parse(localStorage.getItem("orders")) || {};
  const userOrders = allOrders[currentUser] || [];

  const cart = JSON.parse(localStorage.getItem("cart")) || [];
  const buyAgain = JSON.parse(localStorage.getItem("buyAgain")) || {};

  renderOrders(userOrders);
  renderList(cart);
  renderBuyAgain(buyAgain[currentUser] || []);
}

function renderOrders(orders) {
  const container = document.getElementById("ordersList");
  container.innerHTML = "";
  if (!orders.length) {
    container.innerHTML = "<p>No orders found.</p>";
  } else {
    orders.forEach(o => {
      container.innerHTML += `<div class="order-card"><span>${o.name} - ‚Çπ${o.price} x ${o.qty}</span></div>`;
    });
  }
}

function renderList(cart) {
  const container = document.getElementById("listItems");
  container.innerHTML = "";
  if (!cart.length) {
    container.innerHTML = "<p>Your cart is empty.</p>";
  } else {
    cart.forEach(c => {
      container.innerHTML += `<div class="order-card"><span>${c.name} - ‚Çπ${c.price} x ${c.qty}</span></div>`;
    });
  }
}

function renderBuyAgain(items) {
  const container = document.getElementById("buyAgainItems");
  container.innerHTML = "";
  if (!items.length) {
    container.innerHTML = "<p>No previous products.</p>";
  } else {
    items.forEach(b => {
      container.innerHTML += `<div class="order-card"><span>${b.name} - ‚Çπ${b.price} x ${b.qty}</span></div>`;
    });
  }
}

// ---------------------- LOGOUT ----------------------
function logoutUser() {
  localStorage.removeItem("cart");
  localStorage.removeItem("orders");
  alert("You have been logged out!");
  window.location.href = "{{ url_for('logout') }}";
}

// ---------------------- ON PAGE LOAD ----------------------
window.onload = function() {
  renderProfileData();
};
</script>

</body>
</html>
